<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>桌位編排 (Seating Builder)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <link rel="stylesheet" href="seatingbuilder.css">
</head>
<body class="h-screen flex flex-col bg-gray-50 text-gray-800">

    <header class="bg-white border-b border-gray-200 h-14 flex items-center justify-between px-4 shadow-sm z-20 flex-shrink-0">
        <div class="flex items-center gap-3">
            <a href="index.html" class="w-8 h-8 flex items-center justify-center text-gray-500 hover:bg-gray-100 hover:text-blue-600 rounded-lg transition" title="回首頁">
                <i class="fa-solid fa-house"></i>
            </a>
            <div class="w-[1px] h-6 bg-gray-300 mx-1"></div>
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 bg-blue-600 rounded-lg flex items-center justify-center text-white">
                    <i class="fa-solid fa-layer-group"></i>
                </div>
                <div>
                    <h1 class="font-bold text-gray-800 leading-tight">桌位編排</h1>
                    <p class="text-[10px] text-gray-400" id="saveStatus">Ready</p>
                </div>
            </div>
        </div>
        
        <div class="flex items-center gap-2">
            <!-- History Controls -->
            <div class="bg-gray-100 p-1 rounded-lg border border-gray-200 flex gap-1 mr-2">
                <button onclick="undo()" id="btn-undo" class="px-3 py-1 text-xs font-bold rounded text-gray-400 cursor-not-allowed transition" disabled title="復原 (Ctrl+Z)"><i class="fa-solid fa-rotate-left"></i></button>
                <button onclick="redo()" id="btn-redo" class="px-3 py-1 text-xs font-bold rounded text-gray-400 cursor-not-allowed transition" disabled title="重做 (Ctrl+Y)"><i class="fa-solid fa-rotate-right"></i></button>
            </div>

            <!-- Tool Toggle -->
            <div class="bg-gray-100 p-1 rounded-lg border border-gray-200 flex gap-1 mr-2">
                <button onclick="setTool('select')" id="btn-tool-select" class="px-3 py-1 text-xs font-bold rounded shadow bg-white text-blue-600 transition" title="框選模式"><i class="fa-solid fa-vector-square"></i></button>
                <button onclick="setTool('pan')" id="btn-tool-pan" class="px-3 py-1 text-xs font-bold rounded text-gray-500 hover:bg-gray-200 transition" title="拖曳畫布"><i class="fa-solid fa-hand"></i></button>
            </div>

            <!-- Step Navigation -->
            <div class="flex bg-gray-100 p-1 rounded-lg border border-gray-200 mr-2">
                <button onclick="setStep(1)" id="step-btn-1" class="step-btn px-3 py-1 text-xs font-bold rounded transition text-gray-500 hover:bg-gray-200">1. 佈置</button>
                <div class="w-[1px] bg-gray-300 my-1 mx-1"></div>
                <button onclick="setStep(2)" id="step-btn-2" class="step-btn px-3 py-1 text-xs font-bold rounded transition text-gray-500 hover:bg-gray-200">2. 排桌</button>
                <div class="w-[1px] bg-gray-300 my-1 mx-1"></div>
                <button onclick="setStep(3)" id="step-btn-3" class="step-btn px-3 py-1 text-xs font-bold rounded transition text-gray-500 hover:bg-gray-200">3. 排座</button>
                <div class="w-[1px] bg-gray-300 my-1 mx-1"></div>
                <button onclick="setStep(4)" id="step-btn-4" class="step-btn px-3 py-1 text-xs font-bold rounded transition text-gray-500 hover:bg-gray-200">4. 輸出</button>
            </div>

            <div class="flex items-center bg-gray-100 rounded-lg p-1 border border-gray-200 mr-2">
                <button onclick="zoomOut()" class="w-8 h-8 hover:bg-white rounded text-gray-600"><i class="fa-solid fa-minus"></i></button>
                <span id="zoomLevelDisplay" class="text-xs font-mono w-10 text-center text-gray-500">100%</span>
                <button onclick="zoomIn()" class="w-8 h-8 hover:bg-white rounded text-gray-600"><i class="fa-solid fa-plus"></i></button>
                <div class="w-[1px] h-4 bg-gray-300 mx-1"></div>
                <button onclick="autoFitZoom()" class="px-2 h-8 hover:bg-white rounded text-gray-600 text-xs font-bold"><i class="fa-solid fa-expand"></i></button>
            </div>

            <!-- Menu Dropdown -->
            <div class="relative">
                <button onclick="toggleMenu()" id="btn-menu" class="bg-gray-800 hover:bg-gray-700 text-white px-3 py-1.5 rounded shadow text-sm font-bold flex items-center gap-2 transition">
                    <i class="fa-solid fa-bars"></i> 選單
                </button>
                <div id="mainMenu" class="hidden absolute right-0 top-full mt-2 w-56 bg-white rounded-lg shadow-xl border border-gray-200 py-1 z-50 transform origin-top-right transition-all">
                    <div class="px-4 py-2 text-xs font-bold text-gray-400 border-b border-gray-100 bg-gray-50">專案管理</div>
                    <button onclick="exportProject()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-3 transition">
                        <i class="fa-solid fa-download w-4 text-center"></i> 儲存專案 (.json)
                    </button>
                    <button onclick="document.getElementById('importInput').click()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-blue-50 hover:text-blue-600 flex items-center gap-3 transition">
                        <i class="fa-solid fa-upload w-4 text-center"></i> 載入專案 (.json)
                    </button>
                    
                    <div class="px-4 py-2 text-xs font-bold text-gray-400 border-b border-gray-100 bg-gray-50 mt-1">輸出</div>
                    <button onclick="exportExcel()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 flex items-center gap-3 transition"><i class="fa-solid fa-file-excel w-4 text-center text-green-600"></i> 匯出 Excel</button>
                    <button onclick="exportCSVOnly()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-green-50 hover:text-green-700 flex items-center gap-3 transition"><i class="fa-solid fa-file-csv w-4 text-center text-green-600"></i> 匯出 CSV (更新用)</button>
                    <button onclick="exportPDF()" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-red-50 hover:text-red-700 flex items-center gap-3 transition"><i class="fa-solid fa-file-pdf w-4 text-center text-red-600"></i> 匯出 PDF</button>
                    <button onclick="exportWebPackage('single')" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 flex items-center gap-3 transition">
                        <i class="fa-solid fa-globe w-4 text-center text-indigo-600"></i> 打包網頁 (單檔)
                    </button>
                    <button onclick="exportWebPackage('split')" class="w-full text-left px-4 py-3 text-sm text-gray-700 hover:bg-indigo-50 hover:text-indigo-700 flex items-center gap-3 transition">
                        <i class="fa-solid fa-folder-open w-4 text-center text-indigo-600"></i> 打包網頁 (分離+CSV)
                    </button>
                    
                    <div class="border-t border-gray-100 mt-1"></div>
                    <button onclick="resetData()" class="w-full text-left px-4 py-3 text-sm text-red-600 hover:bg-red-50 flex items-center gap-3 transition"><i class="fa-solid fa-trash-can w-4 text-center"></i> 清空重置</button>
                </div>
            </div>
            <input type="file" id="importInput" accept=".json" class="hidden" onchange="importProject(this)">
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden">
        <aside class="w-80 bg-white border-r border-gray-200 flex flex-col shadow-lg z-10 flex-shrink-0">
            <!-- Step 2: Assign Mode (Global Guest List) -->
            <div id="panel-step-2" class="hidden flex-1 flex flex-col overflow-hidden">
                <div class="p-4 border-b bg-white shadow-sm z-10">
                    <h3 class="font-bold text-gray-700 text-sm mb-2"><i class="fa-solid fa-users"></i> 貴賓名單管理</h3>
                    <div class="relative">
                        <input type="text" id="defaultUnitInput" placeholder="預設單位 (選填)" class="w-full border rounded p-1.5 text-sm pl-7">
                        <i class="fa-solid fa-building absolute left-2 top-2 text-gray-400 text-xs"></i>
                    </div>
                    <div class="flex gap-2 text-[10px] bg-white p-1 rounded border text-gray-600">
                        <span class="font-bold pl-1 text-gray-400">輸入模式:</span>
                        <label class="flex items-center gap-1 cursor-pointer hover:text-blue-600"><input type="radio" name="inputMode" value="name" checked> 姓名</label>
                        <label class="flex items-center gap-1 cursor-pointer hover:text-blue-600"><input type="radio" name="inputMode" value="unit"> 單位</label>
                    </div>
                    <textarea id="guestInput" rows="3" class="w-full border rounded p-2 text-sm focus:ring-2 focus:ring-blue-500 outline-none" placeholder="輸入名單... (支援: 財務部 5)"></textarea>
                    <button onclick="parseGuests()" class="w-full bg-gray-800 text-white text-sm py-1.5 rounded hover:bg-black transition">加入名單</button>
                    <div class="flex justify-between text-xs text-gray-500 pt-1">
                        <span>總計: <b id="totalCount">0</b></span>
                        <span class="text-green-600">已排: <b id="seatedCount">0</b></span>
                        <span class="text-red-600">未排: <b id="unseatedCount">0</b></span>
                    </div>
                </div>
                <div class="bg-gray-100 p-1 text-xs text-center font-bold text-gray-500 shadow-inner">未入席清單</div>
                <div id="unseatedList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50"></div>
            </div>

            <!-- Step 1: Layout Mode (Tools) -->
            <div id="panel-step-1" class="hidden flex-1 flex flex-col overflow-y-auto p-4 space-y-4 bg-gray-50">
                <div class="bg-white p-3 rounded-lg border shadow-sm">
                    <h3 class="font-bold text-gray-700 text-sm mb-2"><i class="fa-solid fa-table-cells"></i> 快速生成</h3>
                    <div class="grid grid-cols-3 gap-2 text-xs mb-2">
                        <input type="number" id="colsInput" value="4" class="border rounded p-1" title="橫排">
                        <input type="number" id="rowsInput" value="3" class="border rounded p-1" title="直列">
                        <input type="number" id="gapInput" value="120" class="border rounded p-1" title="間距">
                    </div>
                    <button onclick="generateGridTables()" class="w-full bg-blue-100 text-blue-700 text-sm py-1.5 rounded hover:bg-blue-200">生成矩陣 (適合佈置模式)</button>
                </div>
                <div class="bg-white p-3 rounded-lg border shadow-sm">
                    <h3 class="font-bold text-gray-700 text-sm mb-2"><i class="fa-solid fa-shapes"></i> 加入物件</h3>
                    <div class="grid grid-cols-2 gap-2">
                        <button onclick="addMapObject('table')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-50 transition"><div class="w-8 h-8 rounded-full border-2 border-orange-400 bg-orange-50 mb-1"></div><span class="text-xs">圓桌</span></button>
                        <button onclick="addMapObject('main-table')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-50 transition"><div class="w-8 h-8 rounded-full border-2 border-red-400 bg-red-100 mb-1"></div><span class="text-xs">主桌</span></button>
                        <button onclick="addMapObject('stage')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-50 transition"><div class="w-12 h-6 bg-blue-500 rounded mb-1"></div><span class="text-xs">舞台</span></button>
                        <button onclick="addMapObject('label')" class="flex flex-col items-center p-2 border rounded hover:bg-gray-50 transition"><div class="w-12 h-6 bg-gray-200 border border-gray-400 rounded-full flex items-center justify-center text-[8px] mb-1">入口</div><span class="text-xs">標示</span></button>
                    </div>
                </div>
                <div class="text-xs text-gray-400 px-1">* 建議切換至「佈置 (小)」模式來排列桌子，以獲得最準確的輸出效果。</div>
            </div>

            <!-- Step 3: Seating Mode (Table Specific List) -->
            <div id="panel-step-3" class="hidden flex-1 flex flex-col overflow-hidden bg-gray-50">
                <div class="p-4 border-b bg-white shadow-sm flex-shrink-0">
                    <h3 class="font-bold text-gray-700 text-sm" id="seatingTitle">請選擇桌子</h3>
                    <p class="text-xs text-gray-400 mt-1" id="seatingSubtitle">點擊地圖上的桌子，即可在此處檢視該桌名單並拖曳至座位。</p>
                </div>
                <div class="flex-1 overflow-y-auto p-2 space-y-1 border-b border-gray-200">
                    <div class="text-xs font-bold text-gray-500 mb-1 px-1">本桌名單</div>
                    <div id="seatingList" class="space-y-1"></div>
                </div>
                <div class="h-1/3 flex flex-col border-t border-gray-200 bg-white">
                    <div class="p-2 bg-gray-100 text-xs font-bold text-gray-500 shadow-inner flex-shrink-0">未入席名單 (可拖曳入座)</div>
                    <div id="seatingUnseatedList" class="flex-1 overflow-y-auto p-2 space-y-1 bg-gray-50"></div>
                </div>
            </div>
        </aside>

        <main class="flex-1 relative bg-gray-200 overflow-hidden">
            <div id="floorCanvas" class="w-full h-full relative"><div id="transformLayer"></div></div>
            <div id="selectionMarquee"></div>
            <div class="absolute top-4 right-4 flex flex-col gap-2">
                <div class="bg-white/90 backdrop-blur p-2 rounded shadow-lg border text-xs">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="lockLayout" onchange="toggleLock()" class="accent-blue-600">
                        <span id="lockLabel">🔓 解鎖編輯 (可移動)</span>
                    </label>
                </div>
                <div class="bg-white/90 backdrop-blur p-2 rounded shadow-lg border text-xs">
                    <label class="flex items-center gap-2 cursor-pointer select-none">
                        <input type="checkbox" id="snapGrid" onchange="toggleSnap()" class="accent-blue-600">
                        <span>📏 吸附格點</span>
                    </label>
                </div>
            </div>
            
            <!-- Alignment Toolbar (Floating) -->
            <div id="alignToolbar" class="absolute bottom-8 left-1/2 transform -translate-x-1/2 bg-white/95 backdrop-blur shadow-xl border border-gray-300 rounded-full px-4 py-2 flex gap-3 z-50 hidden transition-all">
                <div class="flex gap-1 border-r pr-3 border-gray-300">
                    <button onclick="alignSelected('left')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="靠左對齊"><i class="fa-solid fa-align-left"></i></button>
                    <button onclick="alignSelected('center-h')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="水平置中"><i class="fa-solid fa-align-center"></i></button>
                    <button onclick="alignSelected('right')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="靠右對齊"><i class="fa-solid fa-align-right"></i></button>
                </div>
                <div class="flex gap-1 border-r pr-3 border-gray-300">
                    <button onclick="alignSelected('top')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="靠上對齊"><i class="fa-solid fa-align-justify fa-rotate-90"></i></button>
                    <button onclick="alignSelected('center-v')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="垂直置中"><i class="fa-solid fa-align-center fa-rotate-90"></i></button>
                    <button onclick="alignSelected('bottom')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="靠下對齊"><i class="fa-solid fa-align-left fa-rotate-90"></i></button>
                </div>
                <div class="flex gap-1">
                    <button onclick="distributeSelected('h')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="水平分佈 (等間距)"><i class="fa-solid fa-ellipsis"></i></button>
                    <button onclick="distributeSelected('v')" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="垂直分佈 (等間距)"><i class="fa-solid fa-ellipsis-vertical"></i></button>
                </div>
                <div class="flex gap-1 border-l pl-3 border-gray-300">
                    <button onclick="arrangeSelectedGrid()" class="p-1.5 hover:bg-blue-50 text-gray-600 hover:text-blue-600 rounded" title="矩陣排列 (Grid)"><i class="fa-solid fa-border-all"></i></button>
                </div>
            </div>
        </main>
    </div>

    <div id="modalOverlay" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-lg p-5 w-80 shadow-2xl transform transition-all">
            <h3 class="font-bold text-lg mb-3">修改名稱</h3>
            <input type="text" id="modalInput" class="w-full border p-2 rounded mb-4 focus:ring-2 focus:ring-blue-500 outline-none">
            <div id="modalCapacityParams" class="mb-4 hidden">
                <label class="block text-xs font-bold text-gray-500 mb-1">座位數 (Capacity)</label>
                <input type="number" id="modalCapacity" class="w-full border p-2 rounded focus:ring-2 focus:ring-blue-500 outline-none" min="1" max="20">
            </div>
            <div class="flex justify-end gap-2">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-500 hover:bg-gray-100 rounded">取消</button>
                <button onclick="saveModal()" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">確定</button>
            </div>
        </div>
    </div>


    <script src="seatingbuilder.js"></script>
</body>
</html>