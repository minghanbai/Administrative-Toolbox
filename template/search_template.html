<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no">
    <title>座位查詢</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body{font-family:sans-serif;background:#fcfcfc;overscroll-behavior:none}
        .seat-circle{transition:all 0.3s;cursor:pointer;fill:#fed7aa;stroke:#f97316;stroke-width:2}
        .seat-active{fill:#fef08a!important;stroke:#eab308!important;stroke-width:4;animation:pulse 1.5s infinite}
        @keyframes pulse{0%{stroke-opacity:1}50%{stroke-opacity:0.5}100%{stroke-opacity:1}}
        .main-table{fill:#fee2e2;stroke:#ef4444}
        .stage{fill:#3b82f6;opacity:0.8}
        .label-box{fill:#e2e8f0;stroke:#94a3b8}
        text{pointer-events:none;font-weight:bold;text-anchor:middle;dominant-baseline:middle;fill:#475569}
        #svg-container{touch-action:none;cursor:grab;width:100%;height:100%}
        #svg-container:active{cursor:grabbing}
    </style>
</head>
<body class="h-screen flex flex-col bg-gray-50">
    <div class="p-4 bg-white shadow z-10 flex-none">
        <div class="relative">
            <i class="fa-solid fa-search absolute left-3 top-4 text-gray-400"></i>
            <input type="text" id="search" class="w-full pl-10 py-3 border rounded-xl bg-gray-50 text-lg" placeholder="搜尋姓名/單位...">
            <i class="fa-solid fa-times-circle absolute right-3 top-4 text-gray-400 hidden cursor-pointer" id="clearBtn" onclick="resetSearch()"></i>
        </div>
        <div class="text-[10px] text-gray-400 text-right mt-1">Update: {{UPDATE_DATE}}</div>
    </div>
    <div class="flex-grow overflow-y-auto relative scroll-smooth" id="main-scroller">
        <div class="h-[50vh] bg-slate-50 relative border-b overflow-hidden flex-none" id="map-wrap">
            <div class="absolute top-2 left-2 z-10 bg-black/50 text-white text-xs px-2 py-1 rounded backdrop-blur-sm pointer-events-none select-none">
                <i class="fa-solid fa-hand-pointer"></i> 雙指縮放 / 單指拖曳
            </div>
            <div class="absolute top-2 right-2 z-10">
                <button onclick="resetZoom()" class="bg-white/90 px-3 py-1 rounded-full shadow text-sm font-bold text-gray-700 hover:bg-gray-100"><i class="fa-solid fa-expand"></i> 全景</button>
            </div>
            <div id="btn-view-seats" class="absolute bottom-4 left-1/2 -translate-x-1/2 z-20 hidden">
                <button onclick="openSeatModal()" class="bg-blue-600 text-white px-4 py-2 rounded-full shadow-lg font-bold text-sm hover:bg-blue-700 transition flex items-center gap-2 animate-bounce"><i class="fa-solid fa-chair"></i> 查看座位</button>
            </div>
            <div id="svg-container"></div>
        </div>
        <div class="bg-white p-4" id="results">
            <div class="text-center text-gray-400 mt-10">請搜尋</div>
        </div>
    </div>
    <div id="seatModal" class="fixed inset-0 bg-black/70 z-50 hidden flex items-center justify-center backdrop-blur-sm" onclick="closeSeatModal()">
        <div class="bg-white p-4 rounded-xl w-[90%] max-w-sm relative shadow-2xl flex flex-col" onclick="event.stopPropagation()">
            <button onclick="closeSeatModal()" class="absolute top-2 right-2 text-gray-400 hover:text-gray-600 w-8 h-8 flex items-center justify-center rounded-full bg-gray-100"><i class="fa-solid fa-times"></i></button>
            <div class="text-center font-bold text-lg mb-2 text-gray-800 hidden" id="modalTitle">座位圖</div>
            <div id="modalSvgBox" class="w-full aspect-square bg-slate-50 rounded-xl border border-slate-200 relative overflow-hidden"></div>
        </div>
    </div>
    <script>
        const data = {{DATA_JSON}};
        const svgBox = document.getElementById('svg-container');
        const viewBox = "{{VIEWBOX}}";
        let currentScale = 1, panX = 0, panY = 0, isPan = false, startP = {x: 0, y: 0}, initialDist = 0, startScale = 1, currentTableId = null;
        
        let svg = `<svg id="mainSvg" viewBox="${viewBox}" style="width:100%;height:100%;transition:transform 0.1s">`;
        
        data.objects.forEach(o => {
            let cx = o.x + o.w / 2;
            let cy = o.y + o.h / 2;
            if (o.type === 'table') {
                svg += `<g id="g-${o.id}" onclick="searchTable('${o.id}')"><circle cx="${cx}" cy="${cy}" r="${o.w / 2}" class="seat-circle" id="s-${o.id}"/><text x="${cx}" y="${cy}" font-size="14">${o.name}</text></g>`
            } else if (o.type === 'main-table') {
                svg += `<g id="g-${o.id}" onclick="searchTable('${o.id}')"><circle cx="${cx}" cy="${cy}" r="${o.w / 2}" class="seat-circle main-table" id="s-${o.id}"/><text x="${cx}" y="${cy}" font-size="16" fill="#b91c1c">${o.name}</text></g>`
            } else if (o.type === 'stage') {
                svg += `<rect x="${o.x}" y="${o.y}" width="${o.w}" height="${o.h}" rx="4" class="stage"/><text x="${cx}" y="${cy}" fill="white">${o.name}</text>`
            } else if (o.type === 'label') {
                svg += `<rect x="${o.x}" y="${o.y}" width="${o.w}" height="${o.h}" rx="4" class="label-box"/><text x="${cx}" y="${cy}">${o.name}</text>`
            }
        });
        svg += '</svg>';
        
        svgBox.innerHTML = svg;
        const svgEl = document.getElementById('mainSvg');
        const searchInput = document.getElementById('search');
        const resDiv = document.getElementById('results');
        
        searchInput.addEventListener('input', e => {
            const q = e.target.value.trim().toLowerCase();
            document.getElementById('clearBtn').style.display = q ? 'block' : 'none';
            if (!q) {
                renderList([]);
                resetMap();
                return
            }
            const hits = data.guests.filter(g => {
                const t = data.objects.find(o => o.id === g.tableId);
                const tName = t ? t.name.toLowerCase() : '';
                return g.name.toLowerCase().includes(q) || g.unit.toLowerCase().includes(q) || tName.includes(q)
            });
            renderList(hits);
            const hitTables = [...new Set(hits.map(g => g.tableId))];
            document.querySelectorAll('.seat-active').forEach(e => e.classList.remove('seat-active'));
            hitTables.forEach(tid => {
                const el = document.getElementById('s-' + tid);
                if (el) el.classList.add('seat-active')
            })
        });

        function searchTable(tid) {
            const obj = data.objects.find(o => o.id === tid);
            if (obj) {
                searchInput.value = obj.name;
                searchInput.dispatchEvent(new Event('input'))
                
                const el = document.getElementById('s-' + tid);
                if (el) el.classList.add('seat-active');
                zoomToTable(tid);
            }
        }

        function renderList(list) {
            if (list.length === 0 && searchInput.value) {
                const isTable = data.objects.some(o => o.name === searchInput.value.trim() && (o.type === 'table' || o.type === 'main-table'));
                resDiv.innerHTML = `<div class="text-center text-gray-400">${isTable ? '此桌目前無安排貴賓' : '查無此人'}</div>`;
                return
            }
            if (list.length === 0) {
                resDiv.innerHTML = '';
                return
            }
            let html = '<div class="space-y-3">';
            list.forEach(g => {
                const t = data.objects.find(o => o.id === g.tableId);
                const tName = t ? t.name : '未定';
                html += `<div class="bg-blue-50 p-3 rounded-lg flex justify-between items-center border border-blue-100 cursor-pointer" onclick="focusTable('${g.tableId}')"><div><div class="font-bold text-lg">${g.name} ${g.count > 1 ? '(x' + g.count + ')' : ''}</div><div class="text-gray-500 text-sm">${g.unit}</div></div><div class="text-2xl font-bold text-blue-600">${tName}</div></div>`
            });
            html += '</div>';
            resDiv.innerHTML = html
        }

        function resetSearch() {
            searchInput.value = '';
            searchInput.dispatchEvent(new Event('input'))
        }

        function resetMap() {
            document.querySelectorAll('.seat-active').forEach(e => e.classList.remove('seat-active'));
            document.getElementById('btn-view-seats').style.display = 'none';
            resetZoom()
        }

        function focusTable(tid) {
            const obj = data.objects.find(o => o.id === tid);
            if (!obj) return;
            document.getElementById('s-' + tid).classList.add('seat-active')
            document.getElementById('main-scroller').scrollTop = 0;
            zoomToTable(tid);
        }
        svgBox.addEventListener('wheel', e => {
            e.preventDefault();
            const s = Math.sign(e.deltaY) > 0 ? 0.9 : 1.1;
            currentScale *= s;
            updateT()
        });
        svgBox.addEventListener('mousedown', e => {
            isPan = true;
            startP = {
                x: e.clientX - panX,
                y: e.clientY - panY
            }
        });
        window.addEventListener('mousemove', e => {
            if (isPan) {
                panX = e.clientX - startP.x;
                panY = e.clientY - startP.y;
                updateT()
            }
        });
        window.addEventListener('mouseup', () => isPan = false);
        
        svgBox.addEventListener('touchstart', e => {
            if (e.touches.length === 1) {
                isPan = true;
                startP = { x: e.touches[0].clientX - panX, y: e.touches[0].clientY - panY }
            } else if (e.touches.length === 2) {
                isPan = false;
                initialDist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                startScale = currentScale
            }
        });
        svgBox.addEventListener('touchmove', e => {
            if (isPan && e.touches.length === 1) {
                e.preventDefault();
                panX = e.touches[0].clientX - startP.x;
                panY = e.touches[0].clientY - startP.y;
                updateT()
            } else if (e.touches.length === 2) {
                e.preventDefault();
                const dist = Math.hypot(e.touches[0].clientX - e.touches[1].clientX, e.touches[0].clientY - e.touches[1].clientY);
                if (initialDist > 0) { currentScale = startScale * (dist / initialDist); updateT() }
            }
        });
        svgBox.addEventListener('touchend', e => {
            if (e.touches.length < 2) initialDist = 0;
            if (e.touches.length === 0) isPan = false
        });

        function updateT() {
            svgEl.style.transform = `translate(${panX}px,${panY}px) scale(${currentScale})`
        }

        function resetZoom() {
            currentScale = 1;
            panX = 0;
            panY = 0;
            updateT()
        }

        function zoomToTable(tid) {
            const obj = data.objects.find(o => o.id === tid);
            if (!obj) return;
            currentTableId = tid;
            
            const hasSeats = data.guests.some(g => g.tableId === tid && g.seatIndex !== undefined);
            document.getElementById('btn-view-seats').style.display = hasSeats ? 'block' : 'none';
            
            const vb = viewBox.split(' ').map(Number);
            const vbX = vb[0], vbY = vb[1], vbW = vb[2], vbH = vb[3];
            const contRect = svgBox.getBoundingClientRect();
            const k = Math.min(contRect.width / vbW, contRect.height / vbH);
            
            const objCx = obj.x + obj.w / 2;
            const objCy = obj.y + obj.h / 2;
            const vbCx = vbX + vbW / 2;
            const vbCy = vbY + vbH / 2;
            
            const dx = (objCx - vbCx) * k;
            const dy = (objCy - vbCy) * k;
            
            currentScale = 3;
            panX = -dx * currentScale;
            panY = -dy * currentScale;
            updateT();
        }

        function openSeatModal() {
            const obj = data.objects.find(o => o.id === currentTableId);
            if(!obj) return;
            document.getElementById('modalTitle').innerText = obj.name;
            
            const box = document.getElementById('modalSvgBox');
            const capacity = obj.capacity || 10;
            const r = 110; // Main circle radius
            const seatR = 22;
            const orbitR = 165;
            const center = 300; // SVG center (600x600)
            
            let svgContent = `<svg viewBox="0 0 600 600" style="width:100%;height:100%">`;
            svgContent += `<circle cx="${center}" cy="${center}" r="${r}" fill="white" stroke="#cbd5e1" stroke-width="2" />`;
            svgContent += `<text x="${center}" y="${center}" font-size="24" fill="#334155">${obj.name}</text>`;
            
            for(let i=0; i<capacity; i++) {
                const angle = (i * (360 / capacity)) - 90;
                const rad = angle * Math.PI / 180;
                const sx = center + orbitR * Math.cos(rad);
                const sy = center + orbitR * Math.sin(rad);
                const guest = data.guests.find(g => g.tableId === obj.id && g.seatIndex === i);
                
                svgContent += `<circle cx="${sx}" cy="${sy}" r="${seatR}" fill="${guest?'#eff6ff':'white'}" stroke="${guest?'#3b82f6':'#cbd5e1'}" stroke-width="1.5" />`;
                if(guest) svgContent += `<text x="${sx}" y="${sy}" font-size="10" fill="#1e40af">${guest.name.substr(0,3)}</text>`;
                else svgContent += `<text x="${sx}" y="${sy}" font-size="9" fill="#cbd5e1">${i+1}</text>`;
            }

            // Auto-detect Stage & Entrance Direction
            const tCx = obj.x + obj.w/2;
            const tCy = obj.y + obj.h/2;

            data.objects.forEach(o => {
                if(o.id === obj.id) return;
                if(o.type !== 'stage' && o.type !== 'label') return;

                const oCx = o.x + o.w/2, oCy = o.y + o.h/2;
                const angle = Math.atan2(oCy - tCy, oCx - tCx);
                const deg = angle * 180 / Math.PI;
                const color = o.type === 'stage' ? '#3b82f6' : '#94a3b8';
                const label = o.name;
                
                // Text position (Radius 280)
                const rText = 280;
                const tx = center + rText * Math.cos(angle);
                const ty = center + rText * Math.sin(angle);
                
                // Arrow position (Radius 240)
                const rArrow = 240;
                const ax = center + rArrow * Math.cos(angle);
                const ay = center + rArrow * Math.sin(angle);
                
                svgContent += `<g transform="translate(${ax}, ${ay}) rotate(${deg})"><path d="M0,0 L-8,-5 L-8,5 Z" fill="${color}" /></g>`;
                svgContent += `<text x="${tx}" y="${ty}" font-size="14" fill="${color}" font-weight="bold">${label}</text>`;
            });

            svgContent += `</svg>`;
            box.innerHTML = svgContent;
            document.getElementById('seatModal').classList.remove('hidden');
            document.getElementById('seatModal').classList.add('flex');
        }
        function closeSeatModal() {
            document.getElementById('seatModal').classList.add('hidden');
            document.getElementById('seatModal').classList.remove('flex');
        }
    </script>
</body>
</html>